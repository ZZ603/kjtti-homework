# 下载的原理

　　我们平时在下载的时候，会遇到很多种下载方式，比如HTTP，FTP，P2P等等，今天我就来简要介绍一下各种下载方式的原理。

## 来归下类

1.http、ftp、https

2.P2P及BT1.0

3.BT2.0——磁力链接

## 简要介绍

1.http、ftp、https：

　　http、ftp、https等在我们日常上网中再寻常不过了，我们经常在浏览器看到如下所示下载框：

![](images\timg.jpg)

这就是常见的http下载方式，ftp与https也类似如此。

优点：下载直接在浏览器中进行，不需要另外的软件；

缺点：这三类下载方式为中央节点应用，也就是说，客户的下载依赖于服务器，假设下载的用户多，那么将造成下载速度慢等问题；假设服务器崩溃，也将导致所有用户下载失败。

这些下载方式即对应下图**Client/Server结构(C/S结构)**模式：

![](http://yzhtml01.book118.com/2016/09/17/03/27821267/8.files/file0002.jpg)

2.P2P及BT1.0：

　　提到上述中央节点的概念，我们会不自然地想要摆脱这种窘况，其实早在20世纪60年代，美国国防部高级研究计划署（DARPA）提出要研制一种崭新的、能够适应现代战争的、生存性很强的网络——**ARPANET**，当今互联网的雏形，

**ARPANET**的宗旨之一是去中心化，原因很简单，存在中央节点无异于存在致命节点，单点失效，将导致整个网络功能失效。

于是便出现了**P2P**(Peer-to-peer networking)

如图所示：

![](https://gss0.bdstatic.com/94o3dSag_xI4khGkpoWK1HF6hhy/baike/c0%3Dbaike92%2C5%2C5%2C92%2C30/sign=715ed9386259252db71a155655f2685e/960a304e251f95ca796fa994cb177f3e6709527d.jpg)

再结合引用自百度百科的解释：

　“对等网络，即对等计算机网络，是一种在对等者（Peer）之间分配任务和工作负载的分布式应用架构，是对等计算模型在应用层形成的一种组网或网络形式。“Peer”在英语里有“对等者、伙伴、对端”的意义。因此，从字面上，P2P可以理解为对等计算或对等网络。国内一些媒体将P2P翻译成“点对点”或者“端对端”，学术界则统一称为对等网络（Peer-to-peer networking）或对等计算（Peer-to-peer computing），其可以定义为：网络的参与者共享他们所拥有的一部分硬件资源（处理能力、存储能力、网络连接能力、打印机等），这些共享资源通过网络提供服务和内容，能被其它对等节点（Peer）直接访问而无需经过中间实体。在此网络中的参与者既是资源、服务和内容的提供者（Server），又是资源、服务和内容的获取者（Client）。

　　在P2P网络环境中，彼此连接的多台计算机之间都处于对等的地位，各台计算机有相同的功能，无主从之分，一台计算机既可作为服务器，设定共享资源供网络中其他计算机所使用，又可以作为工作站，整个网络一般来说不依赖专用的集中服务器，也没有专用的工作站。网络中的每一台计算机既能充当网络服务的请求者，又对其它计算机的请求做出响应，提供资源、服务和内容。通常这些资源和服务包括：信息的共享和交换、计算资源（如CPU计算能力共享）、存储共享（如缓存和磁盘空间的使用）、网络共享、打印机共享等。”

　　我们不难提炼出P2P非中心化的特点：网络中的资源和服务分散在所有节点上，信息的传输和服务的实现都直接在节点之间进行，可以无需中间环节和服务器的介入，避免了可能的瓶颈。

　　而互联网上依靠中央节点才能正常工作的应用其实不在少数，比如我们再熟悉不过的BT。也许你会说：BT不是P2P下载吗？而P2P是没有中心节点的，我们所下载的文件实际上存放在每个网友的电脑中，像FTP这样的应用才是经典的中央节点应用——这话只说对了一半，BT是P2P应用没错，但如果说BT没有中心节点，不会出现“单点失效”，这种看法其实是错误的。
仔细想一想，BT真的不需要中心节点吗？如果是，那为什么国内BT站点关闭后会给下载BT资源带来不便，甚至出现BT客户端无法工作的情况(如2009年12月，中华人民共和国广电总局对BTchina一系列的tracker进行打击)？答案只有一个，BT并非一个去中心化的应用。　
　　
　　上文提到，BT并非一个去中心化的应用。它还需利用到BitTorrent tracker（中文可称：BT服务器、tracker服务器等），它是帮助BitTorrent协议在节点与节点之间做连接的服务器。BitTorrent客户端下载一开始就要连接到tracker，从tracker获得其他客户端IP地址后，才能连接到其他客户端下载。在传输过程中，也会一直与tracker通信，上传自己的信息，获取其它客户端的信息。

　　由于tracker对BT下载起到客户端协调和调控的重要作用，所以一旦被封锁会严重影响BT下载。因此也促使新BT客户端支持[**DHT网络**](https://baike.baidu.com/item/dht%E7%BD%91%E7%BB%9C/96984?fr=aladdin)实现无中心tracker，分布式资源分享的影响。

　　在BT1.0到BT2.0过渡间，有这么一个小插曲：（引用自百科）
[海盗湾的故事](海盗湾的故事)

　　稍微总结一下：P2P下载使得用户下载资源时同时也充当资源提供者，大大提高了下载速度，而且是越多用户下载，下载速度越快。而**DHT网络**更是规划了未来互联网下载的趋势，然而通过上述BT1.0的缺陷及版权方的反对，BT2.0——磁力链接应运而生。

3.BT2.0——磁力链接：

　　在BT2.0时代，Magnet（意译：磁铁、吸铁石）成为未来BT的发展方向，Magnet真的可以挽救BT吗？经笔者亲身试用，在支持Magnet URI之后，海盗湾似乎获得了新生，下载速度并非越来越慢，相反，速度表现让人满意。最关键的是，Magnet不需要Tracker服务器，也不需要Torrent文件，仅需要一串字符就可以进行文件下载。海盗湾LOGO与未来BT的“图腾”，海盗湾上的BT资源已经加入了Magnet下载方式Worlds most resilient tracking——节选自海盗湾博客博文的题目是“世界上最稳定的tracking”，文中提到：“随着DHT+ PEX技术的不断成熟，发现对端（Peer）并协调通信已经变得容易实现，而Tracker服务器变得不再重要，甚至显得有些多余，所以我们将关闭服务器。”文中还说服务器现在被安置在了一家博物馆中。看来，关闭Tracker服务器是计划之内的事情。一切尽在掌握？Tracker服务器和“BT种子”即将双双退役，取而代之的是DHT+ PEX网络和Magnet Link，DHT网络是分布式存在的，所以不存在“被拔线”的问题，而Magnet Link仅是一串字符，所以也不再需要Torrent文件。
　　这里出现了三个关键词：DHT、PEX和Magnet Link，这三点是未来BT的核心，下面我们就来说一说它们都可以实现怎样的功能。
　　DHT：2002年，纽约大学的两个教授Petar Maymounkov和David Mazières发表了一篇论文，提出了一种真正去中心化的“点对点”下载模型，他们将其称为Kademlia方法。2005年，BT软件开始引入这种技术，在BT中被称为DHT协议（Distributed HashTable，分布式哈希表）。DHT是一种分布式存储方法。DHT的作用是找到那些与本机正在下载（上传）相同文件的对端主机（Peer），当然，实现这一过程并不依赖Tracker服务器。在DHT网络中的每个客户端负责一个小范围的路由，并负责存储一小部分数据，从而实现整个DHT网络的寻址和存储。这种信息获取方式保证了整个网络没有单个的中心，即使一个节点下线，依然可以通过其他节点来获取文件，因此也就不需要Tracker服务器来告诉你，其他节点在什么地方。
　　PEX：是Peer Exchange的简写，我们可以将其理解为“节点信息交换”。虽然DHT解决了去中心化的问题，但要在没有“中心协调员”（Tracker）的情况下实现高效寻址，就要借助PEX。PEX所提供的功能有点类似于以前的Tracker服务器，但工作方式却非常不同，我们可以打个比方来说明。小赵在A班，她不认识B班的小何，也不认识C班的小温，但小赵认识同班的小王，而小王认识B班的小何，也可能还认识C班的小温，或者小王仅认识B班的小何，但小何认识C班的小温，而小温又认识同班的所有同学，结果就是小赵可以“无限”地延伸自己的关系网，不管怎样，总有一条沟通途径可以将这些同学联系在一起，待小赵“认识”了小温后，他们就可以直接沟通了，在P2P世界里，就是进行上传与下载。
　　Magnet links：有网友将其称为磁链。DHT+ PEX解决了BT“寻址”的问题，但是如何告诉BT客户端找（寻）什么又是另外一个问题。在Torrent文件中包含的内容就是用户真正要下载的文件的特征信息，或称为“电子指纹”，BT客户端知道了要找什么，也知道如何去找，于是P2P方式的下载、上传就实现了。以前BT客户端通过Torrent文件得知“要找什么”，现在，文件的“电子指纹”不再存放于Torrent中，而被放在了Magnetlinks中。 magnet:?xt=urn:btih:CBCDEFGHIJKLMNOPQRSTUVWXYZ12345678上面是笔者打算下载的一个文件，Microsoft iSCSI Initiator，按照以前的方式，我们需要下载它的Torrent文件，然后才能下载这个文件本身。但是，在新的模式下，我们不需要下载Torrent文件，只需知道它的Magnet URI，一个资源定位信息，其他都不需要。只要把这个地址告诉下载软件，软件就会开始自动下载。我们来分解一下这个地址：magnet：协议名。xt:exact topic的缩写，表示资源定位点。BTIH（BitTorrent Info Hash）表示哈希方法名，这里还可以使用SHA1和MD5。这个值是文件的标识符，是不可缺少的。dn：display name的缩写，表示向用户显示的文件名。这是一个可选项。tr：tracker的缩写，表示tracker服务器的地址。这是一个可选项，本例中并未出现。精简一下上例，仅需要magnet:?xt=urn:btih:DBCDEFGHIJKLMNOPQRSTUVWXYZ12345678就够用了，如果附加dn(displayname)，在使用上会更加方便一些。MagnetLink的好处就不用笔者多说了，至少包括两点：网络的可靠性得到了极大的增强；不存在“被拔线”的风险。由于不存在所谓的中央节点，审查将变得更加困难，“单点失效”的问题也就不存在了。此外，MagnetURI只是一个字符串，非常容易传播，根本无法禁止。因此，Magnet URI取代Tracker模式将是大势所趋，迟早会成为主流BT下载方式。
细心的网友可能看出了DHT+PEX+Magnet Link模式中的一个问题——BT客户端的“第一步是如何迈出的”，套用在介绍PEX时使用的例子，那就是小赵是怎么“加入”A班的呢？这确实是个问题。解决这个问题依然需要一台服务器（boots trap node），不过这台服务器所起的作用与Tracker不同，它仅负责接纳小赵进入A班，当小赵与A班中的同学“搭上了话”，之后这台服务器就没有什么用处了。boots trap node可以是不同BT客户端厂商独立运营的，也可以是几家联合共用，总之，它是分散的，只要在客户端软件中内置一张表单，那客户端就将有非常多的入口可供选择。　
　　说了这么多，到底Magnet这块“吸铁石”表现如何？是骡子是马总要拉出来溜溜。于是笔者找来了目前已经支持Magnet的BT客户端μTorrent。μTorrent 是众多BT客户端之一，在安装过程中我们可以看到，它已经支持Magnet URIs。μTorrent 下载BT资源，速度144.4KB/s 我们下载的资源来自海盗湾，所以对端资源都来自国外，如果有一天Magnet被彻底“本土化”，且用户量达到一定规模，其表现应该可以完全媲美传统的BT下载方式。看到这里相信您已经明白了，海盗湾为什么会乖乖地关掉他们的BT Tracker服务器，看来这次MPAA和RIAA与海盗湾斗法虽然胜了第一回合，但接下来要如何对付DHT+PEX+Magnet Link模式，这应该是个比较让人头疼的问题。 在《猫鼠游戏》这部电影中，警察与“盗版者”之间玩的是游击战。海盗湾的BTTracker服务器也曾有过类似的经历——在几个国家间迁来迁去，在不同的IDC中东躲西藏，但版权组织始终对其“不离不弃”，并最终得手。事后我们在同一时间，很巧合地听到了三种声音，版权组织说，我们赢了；海盗湾说，我们不跟你玩了；广大围观群众说，BT还好好的啊，这些年那两个家伙到底在搞什么？放弃Tracker模式，改用Magnet，对于网友来讲几乎没有任何成本，仅需将当前BT软件升级即可，甚至连操作习惯都不会发生任何变化，因为你无需换用其它BT软件，在国内，比特精灵、比特彗星都已经开始支持Magnet。所以，您可能已经进入了BT2.0时代，只是您自己还不知道。“我们并不提供实体下载资源，所有资源都是网友自发上传的……”相信您经常会听到类似的辩解，这句话看似有理，从技术角度讲也没有任何漏洞，但多少感觉属于狡辩。事物在不停发展，这就造成了监管上的缺失，待监管手段日趋完善时，事物可能又一次向前发展，导致监管手段再次落伍。新的BT分享方式将传统Tracker服务器所提供的功能进行了“分解”，所有BT用户成为Tracker服务器的一份子，核心消失了，在这种情况下，版权组织又该将反盗版的大棒挥向谁呢?



